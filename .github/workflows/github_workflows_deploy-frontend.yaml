name: Deploy Frontend (Dev)

on:
  push:
    branches:
      - main

env:
  BASE_DIR: D:/actions_work/netcore
  SOURCE_DIR: ${{ env.BASE_DIR }}/source/frontend
  BACKUP_DIR: ${{ env.BASE_DIR }}/backup
  DEPLOY_DIR: D:/tool/nginx/html  # Nginx ì •ì  íŒŒì¼ ë£¨íŠ¸ ë””ë ‰í„°ë¦¬ ê²½ë¡œ
  REPO_URL: https://${{ secrets.GITHUB_ACTOR }}:${{ secrets.KTNETCOREACTION }}@github.com/KTNetCoreSolution/frontend.git

  # Nginx ì„œë¹„ìŠ¤ ê´€ë ¨ í™˜ê²½ ë³€ìˆ˜
  SERVICE_NAME: Nginx
  SERVICE_DISPLAY_NAME: Nginx Web Server
  SERVICE_DESCRIPTION: Nginx Web Server for KTNetCoreSolution
  NGINX_PATH: D:/tool/nginx/nginx.exe

permissions:
  contents: write
  id-token: write

jobs:
  deploy-frontend:
    # ì‹¤í–‰ í™˜ê²½ ì„¤ì •
    runs-on: [self-hosted, Windows, X64, frontend-dev]

    steps:
      ### 1. Node.js ë²„ì „ í™•ì¸
      - name: Verify Node.js Installation
        shell: powershell
        run: |
          Write-Output "ğŸ” Verifying installed Node.js and npm versions..."
          node -v
          npm -v

          # Node.js ë²„ì „ í™•ì¸
          $currentVersion = node -v
          if (-not ($currentVersion -match "^v22\.")) {
              Write-Error "âŒ Node.js v22.x is required. Current version: $currentVersion"
              exit 1
          }

      ### 2. Nginxë¥¼ Windows ì„œë¹„ìŠ¤ë¡œ ë“±ë¡ (í•„ìš” ì‹œ)
      - name: Register Nginx as Windows Service
        shell: powershell
        run: |
          Write-Output "ğŸ”„ Checking if the Nginx service is already registered..."

          # ì„œë¹„ìŠ¤ ë“±ë¡ ì—¬ë¶€ í™•ì¸
          $serviceName = "${{ env.SERVICE_NAME }}"
          $serviceDisplayName = "${{ env.SERVICE_DISPLAY_NAME }}"
          $serviceDescription = "${{ env.SERVICE_DESCRIPTION }}"
          $nginxPath = "${{ env.NGINX_PATH }}"

          if (-not (Get-Service -Name $serviceName -ErrorAction SilentlyContinue)) {
              Write-Output "âš™ï¸ Registering Nginx as a Windows service..."
              New-Service -Name $serviceName -DisplayName $serviceDisplayName -Description $serviceDescription -BinaryPathName $nginxPath -StartupType Automatic
              Write-Output "âœ… Nginx is successfully registered as a Windows service."
          } else {
              Write-Output "âœ… Nginx is already registered as a Windows service."
          }

      ### 3. Git Safe Directory ì„¤ì •
      - name: Add Safe Directory
        shell: powershell
        run: |
          git config --global --add safe.directory ${{ env.SOURCE_DIR }}
          Write-Output "âœ… Git safe directory added: ${{ env.SOURCE_DIR }}"

      ### 4. í˜„ì¬ ì†ŒìŠ¤ ì½”ë“œ ë°±ì—…
      - name: Backup Current Source
        shell: powershell
        run: |
          function Backup-Files {
              param([string]$SourcePath, [string]$BackupPath)
              $currentMonthDir = Join-Path -Path $BackupPath -ChildPath (Get-Date -Format 'yyyyMM')
              if (!(Test-Path -Path $currentMonthDir)) {
                  New-Item -ItemType Directory -Path $currentMonthDir -Force
              }
              $currentTime = "$(Get-Date -Format 'yyyyMMdd-HHmmss').zip"
              Compress-Archive -Path "$SourcePath\*" -DestinationPath (Join-Path -Path $currentMonthDir -ChildPath $currentTime) -Force
              Write-Output "âœ… Backup completed at $currentMonthDir."
          }
          Backup-Files -SourcePath "${{ env.SOURCE_DIR }}" -BackupPath "${{ env.BACKUP_DIR }}/source/frontend"

      ### 5. ìµœì‹  ì†ŒìŠ¤ ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
      - name: Checkout Source Code
        shell: powershell
        run: |
          $branch = 'main'

          # ê¸°ì¡´ ì†ŒìŠ¤ ì œê±°
          if (Test-Path -Path "${{ env.SOURCE_DIR }}") {
              Remove-Item -Path "${{ env.SOURCE_DIR }}" -Recurse -Force -ErrorAction SilentlyContinue
          }

          # ìµœì‹  ì½”ë“œë¥¼ í´ë¡ 
          git clone --branch $branch "${{ env.REPO_URL }}" "${{ env.SOURCE_DIR }}"
          Write-Output "âœ… Source code cloned to: ${{ env.SOURCE_DIR }}"
          
      ### 6. .env íŒŒì¼ ë³µì‚¬
      - name: Copy .env file
        shell: powershell
        run: |
          $envSourcePath = 'D:\actions_work\netcore\env\frontend.env.production'
          $envDestinationPath = 'D:\actions_work\netcore\source\backend\.env.production'

          # .env íŒŒì¼ì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸í•˜ê³  ë³µì‚¬
          if (Test-Path -Path $envSourcePath) {
              Copy-Item -Path $envSourcePath -Destination $envDestinationPath -Force
              Write-Output "âœ… .env file copied to: $envDestinationPath"
          } else {
              Write-Output "âŒ .env source file not found: $envSourcePath"
              exit 1  # ì‹¤íŒ¨ ì²˜ë¦¬
          }

      ### 7. ì˜ì¡´ì„± ì„¤ì¹˜ ë° ë¹Œë“œ
      - name: Install and Build Frontend
        shell: powershell
        run: |
          cd "${{ env.SOURCE_DIR }}"
          npm ci
          npm run build

          if ($?) {
              Write-Output "âœ… Frontend build completed successfully."
          } else {
              Write-Error "âŒ Frontend build failed."
              exit 1
          }

      ### 8. ë¹Œë“œ ê²°ê³¼ ë°°í¬ (Nginx ë””ë ‰í„°ë¦¬ë¡œ ë³µì‚¬)
      - name: Deploy Build Files
        shell: powershell
        run: |
          $deployDir = "${{ env.DEPLOY_DIR }}"
          $buildOutput = "${{ env.SOURCE_DIR }}\dist"

          # ê¸°ì¡´ ë°°í¬ íŒŒì¼ ì‚­ì œ
          if (Test-Path -Path $deployDir) {
              Remove-Item -Path $deployDir -Recurse -Force
          }

          # ìƒˆ ë¹Œë“œ íŒŒì¼ ë³µì‚¬
          Copy-Item -Path "$buildOutput\*" -Destination $deployDir -Recurse -Force
          Write-Output "âœ… Build files deployed to: $deployDir"

      ### 9. Nginx ì„œë¹„ìŠ¤ ì¬ì‹œì‘
      - name: Restart Nginx Service
        shell: powershell
        run: |
          $serviceName = "${{ env.SERVICE_NAME }}"

          # Nginx ì„œë¹„ìŠ¤ ì¬ì‹œì‘
          if (Get-Service -Name $serviceName -ErrorAction SilentlyContinue) {
              Write-Output "ğŸ”„ Restarting Nginx service..."
              Restart-Service -Name $serviceName -Force
              Write-Output "âœ… Nginx service restarted successfully."
          } else {
              Write-Error "âŒ Nginx service not found. Please ensure it is properly registered."
              exit 1
          }